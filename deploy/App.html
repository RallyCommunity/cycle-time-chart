<!DOCTYPE html>
<html>
<head>
    <title>AmexApp</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this;this._workspaceConfig=this.getContext().getWorkspace().WorkspaceConfiguration,this.type="HierarchicalRequirement",this.field="ScheduleState",this.beginState="Defined",this.endState="Completed",this.completedState="Accepted",this.lookbackPeriods=6,this.lookbackPeriod="month";var intervals=this.getDateIntervals(this.lookbackPeriod,this.lookbackPeriods);console.log("intervals",intervals);var promises=_.map(intervals,function(interval){var deferred=Ext.create("Deft.Deferred");return that._getCompletedSnapshots(that.type,that.field,that.completedState,interval).then({scope:that,success:function(snapshots){that.completedSnapshots=snapshots,deferred.resolve(snapshots)}}),deferred.getPromise()});Deft.Promise.all(promises).then({scope:that,success:function(intervalCompletedSnapshots){var cPromises=_.map(intervalCompletedSnapshots,function(intCompletedSnapshots,i){var deferred=Ext.create("Deft.Deferred");return that.getCycleTimeSnapshots(intCompletedSnapshots).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred});Deft.Promise.all(cPromises).then({scope:that,success:function(all){console.log("all",all);var chartData=that.prepareChartData(intervals,all);that.createChart(chartData)}})}})},getCycleTimeSnapshots:function(workItems){var that=this,deferred1=new Deft.Deferred;if(0===workItems.length)deferred1.resolve([]);else{var promises=_.map(workItems,function(workItem){var deferred=Ext.create("Deft.Deferred");return that.getSnapshots(workItem).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred.getPromise()});Deft.Promise.all(promises).then({scope:that,success:function(cycleTimes){deferred1.resolve(cycleTimes)},failure:function(error){console.log("failure",error)}})}return deferred1.getPromise()},getWorkItemSnapshots:function(workItems){var that=this,deferred1=new Deft.Deferred,promises=_.map(workItems,function(workItem){var deferred=Ext.create("Deft.Deferred");return that.getSnapshots(workItem).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred.getPromise()});return Deft.Promise.all(promises).then({scope:that,success:function(allWorkItemSnapshots){deferred1.resolve(allWorkItemSnapshots)}}),deferred1.getPromise()},getSnapshots:function(workItem){var that=this,query=that._getProjectScopedQuery(Ext.merge({ObjectID:workItem.get("ObjectID")},that.progressPredicate())),deferred=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(store){for(var snapshots=[],i=0,ii=store.getTotalCount();ii>i;++i)snapshots.push(store.getAt(i).data);deferred.resolve(snapshots)}},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom",that.field],hydrate:[that.field],find:query,sort:{_ValidFrom:1}}),deferred.getPromise()},progressPredicate:function(){var p={};return p[this.field]={$gte:"No Entry"===this.beginState?null:this.beginState,$lt:this.endState},p},getDateIntervals:function(period,periods){var n=moment(),intervals=[],start=moment().startOf(period),end=moment().endOf(period);for(i=0;periods>i;i++)intervals.push({start:start.toISOString(),end:end.toISOString(),name:start.format("MM/DD/YYYY")}),start=start.subtract(1,period),end=end.subtract(1,period);return intervals.reverse()},_getProjectScopedQuery:function(query){return Ext.merge({_ProjectHierarchy:{$in:[Number(this.getContext().getProject().ObjectID)]}},query)},_getCompletedSnapshots:function(type,field,endState,interval){var deferred=new Deft.Deferred,find={_ProjectHierarchy:{$in:[this.getContext().getProject().ObjectID]},_ValidFrom:{$gte:interval.start},_ValidTo:{$lt:interval.end},_TypeHierarchy:{$in:[type]}};find[field]=endState,find["_PreviousValues."+field]={$ne:endState},find["_PreviousValues."+field]={$exists:!0};var fields=["_TypeHierarchy","ObjectID","FormattedID","_ValidFrom","_PreviousValues."+field,field],hydrate=["_PreviousValues."+field,field],config={find:find,fetch:fields,hydrate:hydrate,autoLoad:!0,limit:1/0,listeners:{load:function(store,data,success){deferred.resolve(data)}}};return Ext.create("Rally.data.lookback.SnapshotStore",config),deferred.getPromise()},calcCyleTimeForState:function(stateSnapshots){var that=this,snapshots=stateSnapshots,granularity="day",tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"FormattedID",workDayStartOn:{hour:13,minute:0},workDayEndBefore:{hour:22,minute:0}},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();return results},prepareChartData:function(intervals,results){var that=this,createSeries=function(interval,arrWorkItemSnapshots){return{name:interval.name,data:_.map(_.filter(arrWorkItemSnapshots,function(arr){return arr.length>0}),function(workItemSnapshots){var y=_.first(that.calcCyleTimeForState(workItemSnapshots));return{y:_.isUndefined(y)?null:y.ticks,x:moment.utc(_.last(workItemSnapshots)._ValidFrom).toDate(),workItem:_.first(workItemSnapshots)}})}};return{series:_.map(intervals,function(interval,i){return createSeries(interval,results[i])})}},createChart:function(chartData){var that=this;_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.cycleTimeChart",{itemId:"rally-chart",chartData:chartData}),that.add(that.chart)}});

            Rally.launchApp('CustomApp', {
                name:"AmexApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .chart-container{width:800px;height:300px;margin-left:auto ;margin-right:auto }
    </style>
</head>
<body>
</body>
</html>
