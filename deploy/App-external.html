<!DOCTYPE html>
<html>
<head>
    <title>AmexApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"settings_box"}],config:{defaultSettings:{type:"Story",field:"ScheduleState",states:"In-Progress,Completed",completedState:"Accepted",intervalNumber:"4",intervalType:"week",granularity:"day"}},isExternal:function(){return this.getAppId()===void 0},launch:function(){this.isExternal()?this.showSettings(this.config):this.onSettingsUpdate(this.getSettings())},_launch:function(){var that=this;app=this,app.totalWorkItems=0,this._workspaceConfig=this.getContext().getWorkspace().WorkspaceConfiguration,this.type="Story"===this.getSetting("type")?"HierarchicalRequirement":this.getSetting("type"),this.field=this.getSetting("field"),this.states=this.getSetting("states").split(","),this.completedState=this.getSetting("completedState"),this.lookbackPeriods=this.getSetting("intervalNumber"),this.lookbackPeriod=this.getSetting("intervalType"),this.granularity=this.getSetting("granularity");var intervals=this.getDateIntervals(this.lookbackPeriod,this.lookbackPeriods);console.log("intervals",intervals);var promises=_.map(intervals,function(interval){var deferred=Ext.create("Deft.Deferred");return that._getCompletedSnapshots(that.type,that.field,that.completedState,interval).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred.getPromise()});Deft.Promise.all(promises).then({scope:that,success:function(intervalCompletedSnapshots){that.completedSnapshots=_.flatten(intervalCompletedSnapshots),console.log("Completed Items",that.completedSnapshots),app.totalWorkItems=_.reduce(intervalCompletedSnapshots,function(memo,intSnaps){return memo+intSnaps.length},0);var cPromises=_.map(intervalCompletedSnapshots,function(intCompletedSnapshots,i){var deferred=Ext.create("Deft.Deferred");return that.getCycleTimeSnapshots(intCompletedSnapshots).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred});Deft.Promise.all(cPromises).then({scope:that,success:function(all){console.log("all",all);var chartData=that.prepareChartData(intervals,all);that.createChart(chartData)}})}})},getCycleTimeSnapshots:function(workItems){var that=this,deferred1=new Deft.Deferred;if(0===workItems.length)deferred1.resolve([]);else{var promises=_.map(workItems,function(workItem){var deferred=Ext.create("Deft.Deferred");return that.getSnapshots(workItem).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred.getPromise()});Deft.Promise.all(promises).then({scope:that,success:function(cycleTimes){deferred1.resolve(cycleTimes)},failure:function(error){console.log("failure",error)}})}return deferred1.getPromise()},getWorkItemSnapshots:function(workItems){var that=this,deferred1=new Deft.Deferred,promises=_.map(workItems,function(workItem){var deferred=Ext.create("Deft.Deferred");return that.getSnapshots(workItem).then({scope:that,success:function(snapshots){deferred.resolve(snapshots)}}),deferred.getPromise()});return Deft.Promise.all(promises).then({scope:that,success:function(allWorkItemSnapshots){deferred1.resolve(allWorkItemSnapshots)}}),deferred1.getPromise()},showMask:function(msg){this.getEl()&&(this.getEl().unmask(),this.getEl().mask(msg))},hideMask:function(){this.getEl().unmask()},getSnapshots:function(workItem){var that=this,query=Ext.merge({ObjectID:workItem.get("ObjectID")},that.progressPredicate());console.log("query",JSON.stringify(query));var deferred=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(store){app.totalWorkItems=app.totalWorkItems-1,that.showMask("Loading snapshots for "+app.totalWorkItems+" work items.");for(var snapshots=[],i=0,ii=store.getTotalCount();ii>i;++i)snapshots.push(store.getAt(i).data);deferred.resolve(snapshots)}},fetch:["FormattedID","ObjectID","_ValidTo","_ValidFrom",that.field],hydrate:[that.field],find:query,sort:{_ValidFrom:1}}),deferred.getPromise()},progressPredicate:function(){var p={};return p[this.field]={$in:this.states},p},getDateIntervals:function(period,periods){var n=moment(),intervals=[],start=moment().startOf(period),end=moment().endOf(period);for(i=0;periods>i;i++)intervals.push({start:start.toISOString(),end:end.toISOString(),name:start.format("MM/DD/YYYY")}),start=start.subtract(1,period),end=end.subtract(1,period);return intervals.reverse()},_getProjectScopedQuery:function(query){return Ext.merge({_ProjectHierarchy:{$in:[Number(this.getContext().getProject().ObjectID)]}},query)},_getCompletedSnapshots:function(type,field,endState,interval){var deferred=new Deft.Deferred,find={_ProjectHierarchy:{$in:[this.getContext().getProject().ObjectID]},_ValidFrom:{$gte:interval.start},$or:[{_ValidTo:"9999-01-01T00:00:00.000Z"},{_ValidTo:{$lt:interval.end}}],_TypeHierarchy:{$in:[type]}};find[field]=endState,find["_PreviousValues."+field]={$ne:endState},find["_PreviousValues."+field]={$exists:!0};var fields=["_TypeHierarchy","ObjectID","FormattedID","_ValidFrom","_PreviousValues."+field,field,"Name"],hydrate=["_PreviousValues."+field,field,"_TypeHierarchy"],config={find:find,fetch:fields,hydrate:hydrate,autoLoad:!0,limit:1/0,listeners:{load:function(store,data,success){deferred.resolve(data)}}};return console.log("query",JSON.stringify(config)),Ext.create("Rally.data.lookback.SnapshotStore",config),deferred.getPromise()},calcCyleTimeForState:function(stateSnapshots){var that=this,snapshots=stateSnapshots,granularity=that.granularity,tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"FormattedID",workDayStartOn:{hour:13,minute:0},workDayEndBefore:{hour:22,minute:0}},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();return results},prepareChartData:function(intervals,results){var that=this,createSeries=function(interval,arrWorkItemSnapshots){return{name:interval.name,data:_.map(_.filter(arrWorkItemSnapshots,function(arr){return arr.length>0}),function(workItemSnapshots){var objId=_.first(workItemSnapshots).ObjectID,completedItem=_.find(that.completedSnapshots,function(s){return s.get("ObjectID")===objId}),y=_.first(that.calcCyleTimeForState(workItemSnapshots));return{y:_.isUndefined(y)?null:y.ticks,x:moment.utc(completedItem.get("_ValidFrom")).toDate(),workItem:{FormattedID:completedItem.get("FormattedID"),Name:completedItem.get("Name")}}})}};return{series:_.map(intervals,function(interval,i){return createSeries(interval,results[i])})}},createChart:function(chartData){var that=this;that.unmask(),_.isUndefined(that.chart)||that.remove(that.chart),that.chart=Ext.create("Rally.technicalservices.cycleTimeChart",{itemId:"rally-chart",chartData:chartData}),that.add(that.chart)},showSettings:function(options){return this._appSettings=Ext.create("Rally.app.AppSettings",Ext.apply({fields:this.getSettingsFields(),settings:this.getSettings(),defaultSettings:this.getDefaultSettings(),context:this.getContext(),settingsScope:this.settingsScope,autoScroll:!0},options)),this._appSettings.on("cancel",this._hideSettings,this),this._appSettings.on("save",this._onSettingsSaved,this),this.isExternal()?void 0===this.down("#settings_box").getComponent(this._appSettings.id)&&this.down("#settings_box").add(this._appSettings):(this.hide(),this.up().add(this._appSettings)),this._appSettings},_onSettingsSaved:function(settings){Ext.apply(this.settings,settings),this._hideSettings(),this.onSettingsUpdate(settings)},onSettingsUpdate:function(settings){console.log("onSettingsUpdate",settings),Ext.apply(this,settings),this._launch(settings)},getSettingsFields:function(){var me=this;return[{name:"type",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Type",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'Rally data type for which cycle time is being calculated<br/><span style="color:#999999;">eg.<i>Story</i> <i>Task</i> <i>Defect</i> <i>PortfolioItem/Feature</i></span>'},{name:"field",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"State Field",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'The Rally field used for state<br/><span style="color:#999999;">eg. <i>ScheduleState State</i></span>'},{name:"states",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"States",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'A comma delimited list of the states to calculated cycle time for<br/><span style="color:#999999;">eg. <i>In-Progress,Completed</i></span>'},{name:"completedState",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Completed State",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'The state that represents "completed" <br/><span style="color:#999999;">eg. <i>Accepted</i></span>'},{name:"intervalNumber",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Intervals",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'The number of intervals to report on<br/><span style="color:#999999;">eg. <i>4</i></span>'},{name:"intervalType",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Interval Type",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'The interval type<br/><span style="color:#999999;">eg. <i>week</i><i>day</i><i>month</i></span>'},{name:"granularity",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Granularity",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'Report cycle time in hours or days<br/><span style="color:#999999;">eg. <i>day</i><i>hour</i></span>'}]}});
                Ext.define("Rally.technicalservices.cycleTimeChart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartColors:[],chartConfig:{chart:{type:"scatter",zoomType:"xy"},title:{text:"Cycle Time"},xAxis:{type:"datetime",title:{enabled:!0,text:"Date"},startOnTick:!0,endOnTick:!0},yAxis:[{title:{text:"Days"}}],plotOptions:{scatter:{tooltip:{xDateFormat:"%Y-%m-%d",headerFormat:"<b>{series.name}</b><br>",pointFormat:"{point.x}<br>{point.workItem.FormattedID}:{point.workItem.Name} ({point.y})"}}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});

            Rally.launchApp('CustomApp', {
                name:"AmexApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .chart-container{width:800px;height:300px;margin-left:auto ;margin-right:auto }
    </style>
</head>
<body>
</body>
</html>
